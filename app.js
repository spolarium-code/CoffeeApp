let db;
let cart = [];
const SHOP_NAME = "COFFEE STOCK APP";

// --- RECIPE DEFINITIONS ---
const RECIPES = {
    "coffee": { "coffee": 20 },
    "breakfast meal 1": { "Eggs": 1, "Spam": 1 },
    "matcha": { "matcha powder": 15, "milk": 200 }
};

let request = indexedDB.open("CoffeeStockDB", 10);

request.onupgradeneeded = function (e) {
    db = e.target.result;
    if (!db.objectStoreNames.contains("ingredients")) {
        db.createObjectStore("ingredients", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("products")) {
        db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("sales")) {
        db.createObjectStore("sales", { keyPath: "id", autoIncrement: true });
    }
};

request.onsuccess = function (e) {
    db = e.target.result;
    showDashboard();
};

// --- NAVIGATION & DASHBOARD ---
function showDashboard() {
    document.getElementById("mainContent").innerHTML = `<h2>Inventory Dashboard</h2><div id="ingredientList"></div>`;
    loadIngredients();
}

function loadIngredients() {
    let tx = db.transaction(["ingredients"], "readonly");
    let store = tx.objectStore("ingredients");
    let request = store.getAll();

    request.onsuccess = function () {
        let container = document.getElementById("ingredientList");
        container.innerHTML = "";
        container.style = "display: flex; flex-direction: column; align-items: center; width: 100%;";

        request.result.forEach(item => {
            let packsRemaining = item.totalStock / item.packSize;
            container.innerHTML += `
                <div class="ing-item" style="width: 80%; max-width: 600px; padding: 15px; margin: 5px 0; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
                    <div>
                        <strong style="font-size: 1.4rem;">${item.name}</strong> <small>(${item.category})</small><br>
                        <span>Stock: <strong>${item.totalStock}</strong> ${item.baseUnit} | Packs: <strong>${Math.floor(packsRemaining)}</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" style="width:80px; padding: 8px; font-size: 1rem;" id="use-${item.id}" placeholder="${item.baseUnit}">
                        <button class="btn-use" style="padding: 8px 15px;" onclick="useStock(${item.id})">Use</button>
                        <button class="btn-del" style="padding: 8px 15px;" onclick="deleteIngredient(${item.id})">Delete</button>
                    </div>
                </div>`;
        });
    };
}

function deleteIngredient(id) {
    if (confirm("Are you sure you want to delete this ingredient?")) {
        let tx = db.transaction(["ingredients"], "readwrite");
        tx.objectStore("ingredients").delete(id);
        tx.oncomplete = loadIngredients;
    }
}

function useStock(id) {
    let amount = parseFloat(document.getElementById("use-" + id).value);
    if (!amount || amount <= 0) return alert("Enter valid amount");
    let tx = db.transaction(["ingredients"], "readwrite");
    let store = tx.objectStore("ingredients");
    let request = store.get(id);
    request.onsuccess = function () {
        let item = request.result;
        if (amount > item.totalStock) return alert("Not enough stock!");
        item.totalStock -= amount;
        store.put(item);
        loadIngredients();
    };
}

// --- ADD INGREDIENTS ---
function showAddCoffee() {
    document.getElementById("mainContent").innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; font-size: 1.3rem;">
            <h2 style="font-size: 2rem; margin-bottom: 20px;">Add Coffee Ingredient</h2>
            <input id="name" style="width: 350px; padding: 15px; margin-bottom: 15px; font-size: 1.1rem;" placeholder="Ingredient Name">
            <input id="packSize" type="number" style="width: 350px; padding: 15px; margin-bottom: 15px; font-size: 1.1rem;" placeholder="Pack Size">
            <select id="unit" style="width: 380px; padding: 15px; margin-bottom: 15px; font-size: 1.1rem;">
                <option value="grams">grams</option>
                <option value="kilograms">kilograms</option>
                <option value="ml">ml</option>
                <option value="liters">liters</option>
            </select>
            <input id="packCount" type="number" style="width: 350px; padding: 15px; margin-bottom: 20px; font-size: 1.1rem;" placeholder="Number of Packs">
            <button class="btn-use" style="width: 380px; padding: 15px; font-size: 1.2rem;" onclick="addCoffeeIngredient()">Save Ingredient</button>
        </div>`;
}

function addCoffeeIngredient() {
    let name = document.getElementById("name").value.trim();
    let packSize = parseFloat(document.getElementById("packSize").value);
    let baseUnit = document.getElementById("unit").value;
    let packCount = parseFloat(document.getElementById("packCount").value);

    if (!name) return alert("Enter ingredient name");
    if (!packSize || packSize <= 0) return alert("Enter valid pack size");
    if (!packCount || packCount <= 0) return alert("Enter number of packs");

    let totalStock = packSize * packCount;

    let tx = db.transaction(["ingredients"], "readwrite");
    let store = tx.objectStore("ingredients");

    store.add({
        name,
        packSize,
        baseUnit,
        packCount,
        totalStock,
        category: "coffee"
    });

    tx.oncomplete = function () {
        alert("Coffee ingredient added!");
        showDashboard();
    };

    tx.onerror = function (e) {
        alert("Error: " + e.target.error.message);
    };
}

function showAddBreakfast() {
    document.getElementById("mainContent").innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; font-size: 1.3rem;">
            <h2 style="font-size: 2rem; margin-bottom: 20px;">Add Breakfast Ingredient</h2>
            <select id="type" style="width: 380px; padding: 15px; margin-bottom: 15px; font-size: 1.1rem;">
                <option value="eggs">Eggs (Tray=24)</option>
                <option value="spam">Spam (Can=10)</option>
            </select>
            <input id="packCount" type="number" style="width: 350px; padding: 15px; margin-bottom: 20px; font-size: 1.1rem;" placeholder="Number of Packs">
            <button class="btn-use" style="width: 380px; padding: 15px; font-size: 1.2rem;" onclick="addBreakfastIngredient()">Save Ingredient</button>
        </div>`;
}

function addBreakfastIngredient() {
    let type = document.getElementById("type").value;
    let packCount = parseFloat(document.getElementById("packCount").value);
    if (!packCount) return alert("Enter pack count");
    let name, packSize, baseUnit;
    if (type === "eggs") { name = "Eggs"; packSize = 24; baseUnit = "egg"; }
    else { name = "Spam"; packSize = 10; baseUnit = "slice"; }
    let totalStock = packSize * packCount;
    let tx = db.transaction(["ingredients"], "readwrite");
    tx.objectStore("ingredients").add({ name, packSize, packCount, totalStock, baseUnit, category: "breakfast" });
    tx.oncomplete = showDashboard;
}

// --- PRODUCT MANAGEMENT ---
function showAddProduct() {
    document.getElementById("mainContent").innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; padding-top: 30px;">
            <h2 style="font-size: 2rem;">Add New Product</h2>
            <div style="width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px;">
                <input id="pName" placeholder="Product Name" style="padding: 12px; font-size: 1.1rem;">
                <input id="pPrice" type="number" placeholder="Price (₱)" style="padding: 12px; font-size: 1.1rem;">
                <textarea id="pDesc" placeholder="Product Description" style="height: 60px; padding: 12px; font-size: 1.1rem;"></textarea>
                <div style="text-align: center; border: 1px dashed #ccc; padding: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Product Photo:</label>
                    <input type="file" id="pImage" accept="image/*">
                </div>
                <button class="btn-use" style="padding: 15px; font-size: 1.2rem; margin-top: 10px;" onclick="addProduct()">Save Product</button>
            </div>
        </div>`;
}

function addProduct() {
    let name = document.getElementById("pName").value;
    let price = parseFloat(document.getElementById("pPrice").value);
    let desc = document.getElementById("pDesc").value;
    let fileInput = document.getElementById("pImage");
    if (!name || !price) return alert("Please enter name and price");
    if (fileInput.files && fileInput.files[0]) {
        let reader = new FileReader();
        reader.onload = function(e) { saveProductToDB(name, price, desc, e.target.result); };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        saveProductToDB(name, price, desc, "https://via.placeholder.com/150");
    }
}

function saveProductToDB(name, price, description, imageData) {
    let tx = db.transaction(["products"], "readwrite");
    tx.objectStore("products").add({ name, price, description, image: imageData });
    tx.oncomplete = showProductList;
}

// --- MENU & POS SYSTEM ---
function showProductList() {
    document.getElementById("mainContent").innerHTML = `
        <h2>Menu</h2>
        <div id="productContainer" class="product-grid"></div>
        <div class="cart-panel">
            <h3>Current Order</h3>
            <input type="text" id="custName" placeholder="Customer Name" style="padding:8px; width:200px; margin-bottom:10px;">
            <div id="cartContainer"></div>
            <div style="text-align:right; margin-top:20px; border-top: 1px solid #ddd; padding-top: 15px;">
                <h3 style="margin: 5px 0;">Total: ₱<span id="total">0</span></h3>
                <div style="margin: 10px 0;">
                    <label>Cash Received: ₱</label>
                    <input type="number" id="cashReceived" oninput="calculateChange()" style="padding:8px; width:100px; font-weight:bold;">
                </div>
                <h3 style="color: #2e7d32; margin: 5px 0;">Change: ₱<span id="changeAmount">0.00</span></h3>
                <div style="margin-top: 15px;">
                    <button class="btn-use" style="padding:10px 20px" onclick="checkout()">Checkout & Print</button>
                    <button class="btn-del" style="padding:10px 20px" onclick="clearCart()">Cancel Order</button>
                </div>
            </div>
        </div>`;
    loadProducts();
}

function loadProducts() {
    let tx = db.transaction(["products"], "readonly");
    let request = tx.objectStore("products").getAll();
    request.onsuccess = function () {
        let container = document.getElementById("productContainer");
        container.innerHTML = "";
        request.result.forEach(p => {
            container.innerHTML += `
                <div class="card">
                    <img src="${p.image || 'https://via.placeholder.com/150'}">
                    <strong>${p.name}</strong><br>
                    <small>${p.description || ""}</small><br>
                    <strong style="color: #6F4E37;">₱${p.price}</strong><br><br>
                    <input type="number" id="qty-${p.id}" value="1" min="1" style="width: 50px; margin-bottom:10px;"><br>
                    <button class="btn-use" onclick="prepareAddToCart(${p.id}, '${p.name}', ${p.price})">Add to Order</button>
                    <button class="btn-del" style="margin-top:10px; font-size:10px" onclick="deleteProduct(${p.id})">Delete</button>
                </div>`;
        });
    };
}

function calculateChange() {
    let total = parseFloat(document.getElementById("total").innerText) || 0;
    let cash = parseFloat(document.getElementById("cashReceived").value) || 0;
    let change = cash - total;
    document.getElementById("changeAmount").innerText = change >= 0 ? change.toFixed(2) : "0.00";
}

function prepareAddToCart(id, name, price) {
    let qtyInput = document.getElementById(`qty-${id}`);
    let quantity = parseInt(qtyInput.value);
    if (quantity <= 0 || isNaN(quantity)) return alert("Enter valid quantity");
    addToCart(id, name, price, quantity);
    qtyInput.value = 1;
}

function addToCart(id, name, price, quantity) {
    let existing = cart.find(item => item.id === id);
    if (existing) existing.qty += quantity;
    else cart.push({ id, name, price, qty: quantity });
    renderCart();
}

function renderCart() {
    let container = document.getElementById("cartContainer");
    let total = 0;
    container.innerHTML = "";
    cart.forEach(item => {
        let subtotal = item.price * item.qty;
        total += subtotal;
        container.innerHTML += `
            <div class="cart-item">
                <span>${item.name} x${item.qty}</span>
                <span>₱${subtotal.toFixed(2)} <button class="btn-del" onclick="removeItem(${item.id})">x</button></span>
            </div>`;
    });
    document.getElementById("total").innerText = total.toFixed(2);
    calculateChange();
}

function removeItem(id) {
    cart = cart.filter(item => item.id !== id);
    renderCart();
}

function clearCart() {
    cart = [];
    renderCart();
}

function deleteProduct(id) {
    if (confirm("Delete this product?")) {
        let tx = db.transaction(["products"], "readwrite");
        tx.objectStore("products").delete(id);
        tx.oncomplete = showProductList;
    }
}

// --- CHECKOUT & RECEIPT ---
function checkout() {
    if (cart.length === 0) return alert("Cart is empty");

    let customer = document.getElementById("custName").value || "Walk-in";
    let total = parseFloat(document.getElementById("total").innerText);
    let cash = parseFloat(document.getElementById("cashReceived").value) || 0;

    if (cash < total) return alert("Insufficient cash!");

    try {
        let tx = db.transaction(["sales"], "readwrite");
        let store = tx.objectStore("sales");

        let saleData = {
            customer: customer,
            items: JSON.parse(JSON.stringify(cart)),
            total: total,
            date: new Date().toISOString().split('T')[0],
            timestamp: new Date()
        };

        console.log("Saving sale:", saleData);  // ← DEBUG: Check if data is correct

        let request = store.add(saleData);
        request.onsuccess = function () {
            console.log("Sale saved successfully! ID:", request.result);
            printReceipt(customer, cash, total);
        };
        request.onerror = function (e) {
            console.error("Error saving sale:", e.target.error);
            alert("Error saving sale: " + e.target.error.message);
        };
    } catch (err) {
        console.error("Checkout error:", err);
        alert("System Error: " + err.message);
    }
}

function printReceipt(customer, cash, total) {
    const change = (cash - total).toFixed(2);
    const now = new Date();
    const receiptHTML = `
        <div style="font-family:monospace; width: 280px; padding: 10px;">
            <center><h2 style="margin:0;">${SHOP_NAME}</h2><p>${now.toLocaleString()}</p></center>
            <hr><p>CUSTOMER: ${customer.toUpperCase()}</p>
            <table style="width:100%;">${cart.map(i => `<tr><td>${i.qty}x ${i.name}</td><td style="text-align:right;">₱${(i.price*i.qty).toFixed(2)}</td></tr>`).join('')}</table>
            <hr><p>TOTAL: <span style="float:right;">₱${total.toFixed(2)}</span></p>
            <p>CASH: <span style="float:right;">₱${cash.toFixed(2)}</span></p>
            <p>CHANGE: <span style="float:right; font-weight:bold;">₱${change}</span></p>
            <center><p style="margin-top:20px;">Thank you!</p></center>
        </div>`;

    const printWin = window.open('', '_blank', 'width=400,height=600');
    if (!printWin) return alert("Allow pop-ups to print receipts!");

    printWin.document.write('<html><body>' + receiptHTML + '</body></html>');
    printWin.document.close();
    setTimeout(() => { printWin.print(); printWin.close(); }, 500);

    cart = [];
    renderCart();
    document.getElementById("custName").value = "";
    document.getElementById("cashReceived").value = "";
}

// --- REPORTS (SURGICAL UPDATE FOR LOGIC) ---
function showReports() {
    document.getElementById("mainContent").innerHTML = `
        <h2>Reports</h2>
        <div class="card" style="background: #eee; padding:15px;">
            From: <input type="date" id="dateFrom"> To: <input type="date" id="dateTo">
            <button class="btn-use" onclick="generateReport('income')">Income Report</button>
            <button class="btn-use" style="background:#8d6e63" onclick="generateReport('usage')">Usage Report</button>
        </div>
        <div id="reportResult" style="margin-top:20px; background:white; padding:20px;"></div>`;
}

function generateReport(type) {
    let from = document.getElementById("dateFrom").value;
    let to = document.getElementById("dateTo").value;

    console.log("Report requested:", { type, from, to });

    if (!from || !to) {
        alert("Select date range");
        return;
    }

    let tx = db.transaction(["sales"], "readonly");
    let request = tx.objectStore("sales").getAll();

    request.onsuccess = function () {
        let allSales = request.result;
        console.log("All sales in DB:", allSales);  // ← See EVERY sale

        let filtered = allSales.filter(s => {
            let saleDate = s.date;
            console.log("Checking sale date:", saleDate, "against", from, "to", to);
            let saleDateObj = new Date(saleDate);
let fromObj = new Date(from);
let toObj = new Date(to);
return saleDateObj >= fromObj && saleDateObj <= toObj;
        });

        console.log("Filtered sales for report:", filtered);

        if (filtered.length === 0) {
            document.getElementById("reportResult").innerHTML = `
                <p>No sales found in this date range.</p>
                <p>Debug info: ${allSales.length} total sales in DB. Check console for details.</p>`;
            return;
        }

        if (type === 'income') {
            renderIncomeReport(filtered, from, to);
        } else if (type === 'usage') {
            renderUsageReport(filtered, from, to);
        }
    };

    request.onerror = function (e) {
        console.error("Error reading sales:", e.target.error);
        alert("Error loading sales: " + e.target.error.message);
    };
}

function renderIncomeReport(data, from, to) {
    let grandTotal = 0;
    let html = `
        <div id="reportToExport">
            <h2 style="text-align:center;">Detailed Income Report</h2>
            <p style="text-align:center;">${from} to ${to}</p>
            <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background:#f2f2f2;">
                        <th style="border:1px solid #ddd; padding:8px;">Date</th>
                        <th style="border:1px solid #ddd; padding:8px;">Customer</th>
                        <th style="border:1px solid #ddd; padding:8px;">Items Ordered</th>
                        <th style="border:1px solid #ddd; padding:8px; text-align:right;">Total</th>
                    </tr>
                </thead>
                <tbody>`;

    data.forEach(sale => {
        grandTotal += sale.total;
        let itemsList = sale.items.map(i => `${i.qty} × ${i.name} (₱${(i.price * i.qty).toFixed(2)})`).join('<br>');

        html += `
            <tr>
                <td style="border:1px solid #ddd; padding:8px;">${sale.date}</td>
                <td style="border:1px solid #ddd; padding:8px;">${sale.customer}</td>
                <td style="border:1px solid #ddd; padding:8px;">${itemsList}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:right;">₱${sale.total.toFixed(2)}</td>
            </tr>`;
    });

    html += `
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold; background:#eee;">
                        <td colspan="3" style="text-align:right; padding:8px;">GRAND TOTAL:</td>
                        <td style="text-align:right; padding:8px;">₱${grandTotal.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <br>
        <button class="btn-use" onclick="saveReportAsPDF('${from}_Income')">Save Report as PDF</button>`;

    document.getElementById("reportResult").innerHTML = html;
}
function renderUsageReport(data, from, to) {
    let usageSummary = {};

    data.forEach(sale => {
        sale.items.forEach(item => {
            let productName = item.name.toLowerCase().trim();
            // Try to match recipe key by partial or exact (more forgiving)
            let matchedRecipe = Object.keys(RECIPES).find(key => 
                key.toLowerCase().includes(productName) || productName.includes(key.toLowerCase())
            );

            if (matchedRecipe && RECIPES[matchedRecipe]) {
                for (let ing in RECIPES[matchedRecipe]) {
                    let amountUsed = RECIPES[matchedRecipe][ing] * item.qty;
                    usageSummary[ing] = (usageSummary[ing] || 0) + amountUsed;
                }
            }
        });
    });

    if (Object.keys(usageSummary).length === 0) {
        document.getElementById("reportResult").innerHTML = "<p>No ingredient usage detected. Make sure products sold match recipe names (e.g. 'coffee', 'breakfast meal 1', 'matcha').</p>";
        return;
    }

    let html = `
        <div id="reportToExport">
            <h2 style="text-align:center;">Stock Usage Summary</h2>
            <p style="text-align:center;">${from} to ${to}</p>
            <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background:#f2f2f2;">
                        <th>Ingredient</th>
                        <th style="text-align:right;">Amount Used</th>
                    </tr>
                </thead>
                <tbody>`;

    for (let ing in usageSummary) {
        let unit = ing.toLowerCase().includes("egg") ? "pcs" :
                   ing.toLowerCase().includes("spam") ? "slices" : "grams/ml";

        html += `
            <tr>
                <td style="border:1px solid #ddd; padding:8px;">${ing.toUpperCase()}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:right;">${usageSummary[ing]} ${unit}</td>
            </tr>`;
    }

    html += `
                </tbody>
            </table>
        </div>
        <br>
        <button class="btn-use" onclick="saveReportAsPDF('${from}_Usage')">Save Usage as PDF</button>`;

    document.getElementById("reportResult").innerHTML = html;
}

function saveReportAsPDF(fileName) {
    const reportContent = document.getElementById("reportToExport").innerHTML;
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.write(`
        <html>
            <head>
                <title>${fileName}</title>
                <style>
                    body { font-family: Arial; padding: 40px; }
                    table { width:100%; border-collapse: collapse; }
                    th, td { border:1px solid #ddd; padding:12px; text-align:left; }
                    th { background:#f2f2f2; }
                </style>
            </head>
            <body>
                <h1 style="text-align:center;">${SHOP_NAME}</h1>
                ${reportContent}
                <script>
                    window.onload = function() {
                        window.print();
                        window.onafterprint = function() { window.close(); };
                    };
                </script>
            </body>
        </html>`);
    printWindow.document.close();
}

function toggleFullscreen() {
    let elem = document.documentElement;
    if (!document.fullscreenElement) {
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    } else {
        if (document.exitFullscreen) document.exitFullscreen();
    }
}